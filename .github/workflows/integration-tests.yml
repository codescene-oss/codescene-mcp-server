name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      run_docker:
        description: 'Run Docker variant tests'
        type: boolean
        default: true
      run_static:
        description: 'Run Static binary variant tests'
        type: boolean
        default: true

concurrency:
  group: integration-tests-${{ github.ref }}
  cancel-in-progress: true

env:
  CS_ACCESS_TOKEN: ${{ secrets.CS_ACCESS_TOKEN }}

jobs:
  # =============================================================================
  # Static Binary Tests - Linux
  # =============================================================================
  static-linux:
    if: ${{ inputs.run_static }}
    runs-on: ubuntu-latest
    name: Static Tests (Linux)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r src/requirements.txt
          pip install Nuitka

      - name: Run path resolution tests (static variant)
        run: |
          source .venv/bin/activate
          ./tests/path-resolution-integration/run-static-test.sh

      - name: Run SSL tests (static variant)
        run: |
          source .venv/bin/activate
          ./tests/ssl-integration/run-ssl-test.sh static

  # =============================================================================
  # Static Binary Tests - macOS (Apple Silicon)
  # =============================================================================
  static-macos:
    if: ${{ inputs.run_static }}
    runs-on: macos-latest
    name: Static Tests (macOS)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r src/requirements.txt
          pip install Nuitka

      - name: Run path resolution tests (static variant)
        run: |
          source .venv/bin/activate
          ./tests/path-resolution-integration/run-static-test.sh

      - name: Run SSL tests (static variant)
        run: |
          source .venv/bin/activate
          ./tests/ssl-integration/run-ssl-test.sh static

  # =============================================================================
  # Static Binary Tests - Windows
  # =============================================================================
  static-windows:
    if: ${{ inputs.run_static }}
    runs-on: windows-latest
    name: Static Tests (Windows)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Create virtual environment and install dependencies
        shell: pwsh
        run: |
          python -m venv venv
          .\venv\Scripts\python -m pip install --upgrade pip
          .\venv\Scripts\pip install -r src/requirements.txt
          .\venv\Scripts\pip install Nuitka

      - name: Run path resolution tests (static variant)
        shell: pwsh
        run: |
          .\tests\path-resolution-integration\run-windows-test.ps1

  # =============================================================================
  # Docker Tests - Linux
  # =============================================================================
  docker-linux:
    if: ${{ inputs.run_docker }}
    runs-on: ubuntu-latest
    name: Docker Tests (Linux)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install Python dependencies (for test scripts)
        run: |
          pip install --upgrade pip
          pip install -r src/requirements.txt

      - name: Run path resolution tests (docker variant)
        run: ./tests/path-resolution-integration/run-docker-test.sh

      - name: Run SSL tests (docker variant)
        run: ./tests/ssl-integration/run-ssl-test.sh docker


