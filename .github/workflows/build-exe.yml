name: Build and publish executables

on: 
  # pull_request:
  #   branches:
  #     - main
  push:
    tags:
      - 'MCP-[0-9]+.[0-9]+.[0-9]+'
      - 'MCP-[0-9]+.[0-9]+.[0-9]+-*'
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-exe-unix:
    permissions:
      contents: read

    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-linux-amd64-latest.zip
            artifact-name: cs-mcp-linux-amd64
            output-path: cs-mcp
          - os: ubuntu-22.04-arm
            arch: aarch64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-linux-aarch64-latest.zip
            artifact-name: cs-mcp-linux-aarch64
            output-path: cs-mcp
          - os: macos-14-large
            arch: amd64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-macos-amd64-latest.zip
            artifact-name: cs-mcp-macos-amd64
            output-path: cs-mcp
          - os: macos-latest
            arch: aarch64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-macos-aarch64-latest.zip
            artifact-name: cs-mcp-macos-aarch64
            output-path: cs-mcp
            
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13' 

      - name: Install deps
        run: |
          python -m venv .venv/
          source .venv/bin/activate
          pip install -r src/requirements.txt
          pip install Nuitka

      - name: Download CodeScene CLI
        run: |
          wget ${{ matrix.cli-url }} -O codescene-cli.zip
          unzip codescene-cli.zip -d .

      - name: Inject version into version.py
        run: |
          VERSION="${{ github.ref_name }}"
          sed -i.bak "s/__version__ = \"dev\"/__version__ = \"${VERSION}\"/" src/version.py
          echo "Injected version: $VERSION"
          cat src/version.py

      - name: Build Executable
        run: |
          source .venv/bin/activate
          make create-executable

      - name: Rename binary to include platform info
        run: mv ${{ matrix.output-path }} ${{ matrix.artifact-name }}

      - name: Verify Linux executable (optional)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          BIN="${{ matrix.artifact-name }}"
          chmod +x "$BIN" || true
          ./"$BIN" --help >/dev/null 2>&1 || true

      - name: Generate checksum (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          BIN="${{ matrix.artifact-name }}"
          sha256sum "$BIN" > "${BIN}.sha256"

      - name: Check for Linux signing secrets
        if: startsWith(matrix.os, 'ubuntu') && github.event_name == 'push'
        id: check-linux-secrets
        shell: bash
        run: |
          if [[ -n "${{ secrets.LINUX_GPG_PRIVATE_KEY }}" \
             && -n "${{ secrets.LINUX_GPG_KEY_ID }}" \
             && -n "${{ secrets.LINUX_GPG_PASSPHRASE }}" ]]; then
            echo "can-sign=true" >> "$GITHUB_OUTPUT"
          else
            echo "can-sign=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import GPG key (Linux)
        if: startsWith(matrix.os, 'ubuntu') && github.event_name == 'push' && steps.check-linux-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          LINUX_GPG_PRIVATE_KEY: ${{ secrets.LINUX_GPG_PRIVATE_KEY }}
        run: |
          echo "$LINUX_GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Sign checksum (Linux)
        if: startsWith(matrix.os, 'ubuntu') && github.event_name == 'push' && steps.check-linux-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          LINUX_GPG_KEY_ID: ${{ secrets.LINUX_GPG_KEY_ID }}
          LINUX_GPG_PASSPHRASE: ${{ secrets.LINUX_GPG_PASSPHRASE }}
        run: |
          BIN="${{ matrix.artifact-name }}"
          gpg --batch --yes --pinentry-mode loopback \
              --passphrase "$LINUX_GPG_PASSPHRASE" \
              --local-user "$LINUX_GPG_KEY_ID" \
              --armor \
              --output "${BIN}.sha256.asc" \
              --sign "${BIN}.sha256"

        
      - name: Check for macOS signing secrets
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push'
        id: check-mac-secrets
        shell: bash
        run: |
          if [[ -n "${{ secrets.MACOS_CERTIFICATE }}" \
             && -n "${{ secrets.MACOS_CERTIFICATE_PWD }}" \
             && -n "${{ secrets.APPLE_DEVELOPER_ID }}" \
             && -n "${{ secrets.APPLE_ID }}" \
             && -n "${{ secrets.APPLE_APP_PASSWORD }}" \
             && -n "${{ secrets.APPLE_TEAM_ID }}" ]]; then
            echo "can-sign=true" >> "$GITHUB_OUTPUT"
          else
            echo "can-sign=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import Apple Developer Certificate (keychain)
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PWD: keychainpassword
        run: |
          security create-keychain -p "$KEYCHAIN_PWD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PWD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Decode certificate using printf to avoid newline issues
          printf '%s' "$MACOS_CERTIFICATE" | base64 -D -o certificate.p12
          
          # Verify the file was created and has content
          if [[ ! -s certificate.p12 ]]; then
            echo "::error::Failed to decode certificate - file is empty or missing"
            exit 1
          fi
          
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" build.keychain
          rm -f certificate.p12

      - name: Codesign macOS executable
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          BIN="${{ matrix.artifact-name }}"
          if [[ ! -f "$BIN" ]]; then
            echo "::error::Expected macOS binary at '$BIN' but it was not found."
            ls -la
            exit 1
          fi

          codesign --force --options runtime --sign "$APPLE_DEVELOPER_ID" --timestamp "$BIN"
          codesign --verify --verbose "$BIN"

      - name: Notarize macOS executable
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          BIN="${{ matrix.artifact-name }}"
          ZIP="notarize-${{ matrix.arch }}.zip"

          ditto -c -k --keepParent "$BIN" "$ZIP"
          xcrun notarytool submit "$ZIP" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      - name: Staple notarization ticket
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        run: |
          BIN="${{ matrix.artifact-name }}"
          # Stapling doesn't work for standalone executables (only .app, .dmg, .pkg)
          # The notarization is still valid - macOS checks with Apple servers at runtime
          echo "::notice::Skipping staple for standalone executable (not supported by Apple)"
          echo "Notarization is valid - Gatekeeper will verify online"

      - name: Clean up keychain
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true' && always()
        shell: bash
        run: |
          security default-keychain -s login.keychain
          security delete-keychain build.keychain || true
          rm -f notarize-*.zip || true

      - name: Set executable permissions and zip (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          chmod +x "${{ matrix.artifact-name }}"
          zip "${{ matrix.artifact-name }}.zip" "${{ matrix.artifact-name }}"

      - name: Zip binary with checksums (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          BIN="${{ matrix.artifact-name }}"
          chmod +x "$BIN"
          # Include binary and any checksum files in the zip
          zip "${BIN}.zip" "$BIN" ${BIN}.sha256 ${BIN}.sha256.asc 2>/dev/null || zip "${BIN}.zip" "$BIN" ${BIN}.sha256 2>/dev/null || zip "${BIN}.zip" "$BIN"

      - name: Upload Executable Artifact (zipped binary)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-name }}.zip

  build-exe-windows-amd64:
    runs-on: windows-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5 # Standard stable version
        with:
          python-version: '3.13'

      - name: Install deps
        run: |
          python -m venv venv
          .\venv\Scripts\python -m pip install --upgrade pip
          .\venv\Scripts\pip install -r src/requirements.txt
          .\venv\Scripts\pip install Nuitka

      - name: Download CodeScene CLI zip
        run: |
          Invoke-WebRequest -Uri "https://downloads.codescene.io/enterprise/cli/cs-windows-amd64-latest.zip" -OutFile "codescene-cli-windows.zip"
          Expand-Archive -Path "codescene-cli-windows.zip" -DestinationPath "."

      - name: Inject version into version.py
        run: |
          $version = "${{ github.ref_name }}"
          (Get-Content src/version.py) -replace '__version__ = "dev"', "__version__ = `"$version`"" | Set-Content src/version.py
          Write-Host "Injected version: $version"
          Get-Content src/version.py

      - name: Build Executable
        run: |
          .\venv\Scripts\python -m nuitka --onefile `
            --assume-yes-for-downloads `
            --lto=yes `
            --noinclude-pytest-mode=nofollow `
            --noinclude-unittest-mode=nofollow `
            --noinclude-setuptools-mode=nofollow `
            --noinclude-pydoc-mode=nofollow `
            --include-data-dir=./src/docs=src/docs `
            --include-data-dir=./src/code_health_refactoring_business_case/s_curve/regression=code_health_refactoring_business_case/s_curve/regression `
            --include-data-files=./cs.exe=cs.exe `
            --output-filename=cs-mcp.exe `
            src/cs_mcp_server.py

      - name: Rename binary to include platform info
        run: Rename-Item -Path "cs-mcp.exe" -NewName "cs-mcp-windows-amd64.exe"

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Sign with Azure Trusted Signing (OIDC)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ secrets.AZURE_TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ secrets.AZURE_TRUSTED_SIGNING_ACCOUNT }}
          certificate-profile-name: ${{ secrets.AZURE_TRUSTED_SIGNING_CERT_PROFILE }}
          files: |
            ${{ github.workspace }}\cs-mcp-windows-amd64.exe
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256

      - name: Upload Executable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cs-mcp-windows-amd64
          path: cs-mcp-windows-amd64.exe

  # build-exe-windows-aarch64:
  #   runs-on: windows-11-arm
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
      
  #     - uses: actions/setup-python@v5 # Standard stable version
  #       with:
  #         python-version: '3.13'

  #     - name: Install deps
  #       run: |
  #         python -m venv venv
  #         .\venv\Scripts\python -m pip install --upgrade pip
  #         .\venv\Scripts\pip install -r src/requirements.txt
  #         .\venv\Scripts\pip install Nuitka

  #     - name: Download CodeScene CLI zip
  #       run: |
  #         Invoke-WebRequest -Uri "https://downloads.codescene.io/enterprise/cli/cs-windows-amd64-latest.zip" -OutFile "codescene-cli-windows.zip"
  #         Expand-Archive -Path "codescene-cli-windows.zip" -DestinationPath "."

  #     - name: Build Executable
  #       run: |
  #         .\venv\Scripts\python -m nuitka --onefile `
  #           --assume-yes-for-downloads `
  #           --include-data-dir=./src/docs=src/docs `
  #           --include-data-files=./cs.exe=cs `
  #           --output-filename=cs-mcp.exe `
  #           src/cs_mcp_server.py

  #     - name: Upload Executable Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: cs-mcp-aarch64.exe
        
  publish-to-release:
    permissions:
      contents: write 
    needs: [build-exe-unix, build-exe-windows-amd64]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-binaries
          merge-multiple: true

      - name: Upload to Existing Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ./all-binaries/*
          append_body: true