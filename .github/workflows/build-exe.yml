name: Build and publish executables

on: 
  # pull_request:
  #   branches:
  #     - main
  push:
    tags:
      - 'MCP-[0-9]+.[0-9]+.[0-9]+'
      - 'MCP-[0-9]+.[0-9]+.[0-9]+-*'
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-exe-unix:
    permissions:
      contents: read

    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: amd64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-linux-amd64-latest.zip
            artifact-name: cs-mcp-linux-amd64
            output-path: cs-mcp
          - os: ubuntu-24.04
            arch: aarch64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-linux-aarch64-latest.zip
            artifact-name: cs-mcp-linux-aarch64
            output-path: cs-mcp
          - os: macos-14-large
            arch: amd64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-macos-amd64-latest.zip
            artifact-name: cs-mcp-macos-amd64
            output-path: cs-mcp
          - os: macos-latest
            arch: aarch64
            cli-url: https://downloads.codescene.io/enterprise/cli/cs-macos-aarch64-latest.zip
            artifact-name: cs-mcp-macos-aarch64
            output-path: cs-mcp
            
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13' 

      - name: Install deps
        run: |
          python -m venv .venv/
          source .venv/bin/activate
          pip install -r src/requirements.txt
          pip install Nuitka

      - name: Download CodeScene CLI
        run: |
          wget ${{ matrix.cli-url }} -O codescene-cli.zip
          unzip codescene-cli.zip -d .

      - name: Build Executable
        run: |
          source .venv/bin/activate
          make create-executable

      - name: Verify Linux executable (optional)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          BIN="${{ matrix.output-path }}"
          chmod +x "$BIN" || true
          ./"$BIN" --help >/dev/null 2>&1 || true

      - name: Generate checksum (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          BIN="${{ matrix.output-path }}"
          sha256sum "$BIN" > "${BIN}.sha256"

      - name: Check for Linux signing secrets
        if: startsWith(matrix.os, 'ubuntu') && github.event_name == 'push'
        id: check-linux-secrets
        shell: bash
        run: |
          if [[ -n "${{ secrets.LINUX_GPG_PRIVATE_KEY }}" \
             && -n "${{ secrets.LINUX_GPG_KEY_ID }}" \
             && -n "${{ secrets.LINUX_GPG_PASSPHRASE }}" ]]; then
            echo "can-sign=true" >> "$GITHUB_OUTPUT"
          else
            echo "can-sign=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import GPG key (Linux)
        if: startsWith(matrix.os, 'ubuntu') && github.event_name == 'push' && steps.check-linux-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          LINUX_GPG_PRIVATE_KEY: ${{ secrets.LINUX_GPG_PRIVATE_KEY }}
        run: |
          echo "$LINUX_GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Sign checksum (Linux)
        if: startsWith(matrix.os, 'ubuntu') && github.event_name == 'push' && steps.check-linux-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          LINUX_GPG_KEY_ID: ${{ secrets.LINUX_GPG_KEY_ID }}
          LINUX_GPG_PASSPHRASE: ${{ secrets.LINUX_GPG_PASSPHRASE }}
        run: |
          BIN="${{ matrix.output-path }}"
          gpg --batch --yes --pinentry-mode loopback \
              --passphrase "$LINUX_GPG_PASSPHRASE" \
              --local-user "$LINUX_GPG_KEY_ID" \
              --armor \
              --output "${BIN}.sha256.asc" \
              --sign "${BIN}.sha256"

        
      - name: Check for macOS signing secrets
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push'
        id: check-mac-secrets
        shell: bash
        run: |
          if [[ -n "${{ secrets.MACOS_CERTIFICATE }}" \
             && -n "${{ secrets.MACOS_CERTIFICATE_PWD }}" \
             && -n "${{ secrets.APPLE_DEVELOPER_ID }}" \
             && -n "${{ secrets.APPLE_ID }}" \
             && -n "${{ secrets.APPLE_APP_PASSWORD }}" \
             && -n "${{ secrets.APPLE_TEAM_ID }}" ]]; then
            echo "can-sign=true" >> "$GITHUB_OUTPUT"
          else
            echo "can-sign=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import Apple Developer Certificate (keychain)
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PWD: keychainpassword
        run: |
          security create-keychain -p "$KEYCHAIN_PWD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PWD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Ne ispisuj sadrÅ¾aj cert-a (nema echo/cat), samo decode u file
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" build.keychain
          rm -f certificate.p12

      - name: Codesign macOS executable
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          BIN="${{ matrix.output-path }}"
          if [[ ! -f "$BIN" ]]; then
            echo "::error::Expected macOS binary at '$BIN' but it was not found."
            ls -la
            exit 1
          fi

          codesign --force --options runtime --sign "$APPLE_DEVELOPER_ID" --timestamp "$BIN"
          codesign --verify --verbose "$BIN"

      - name: Notarize macOS executable
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          BIN="${{ matrix.output-path }}"
          ZIP="notarize-${{ matrix.arch }}.zip"

          ditto -c -k --keepParent "$BIN" "$ZIP"
          xcrun notarytool submit "$ZIP" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      - name: Staple notarization ticket
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true'
        shell: bash
        run: |
          BIN="${{ matrix.output-path }}"
          xcrun stapler staple "$BIN"
          xcrun stapler validate "$BIN" || true

      - name: Clean up keychain
        if: startsWith(matrix.os, 'macos') && github.event_name == 'push' && steps.check-mac-secrets.outputs.can-sign == 'true' && always()
        shell: bash
        run: |
          security default-keychain -s login.keychain
          security delete-keychain build.keychain || true
          rm -f notarize-*.zip || true

      - name: Upload Executable Artifact (binary)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.output-path }}

      - name: Upload Linux checksum
        if: startsWith(matrix.os, 'ubuntu')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}-checksums
          path: |
            ${{ matrix.output-path }}.sha256

      - name: Upload Linux checksum signature
        if: startsWith(matrix.os, 'ubuntu') && github.event_name == 'push' && steps.check-linux-secrets.outputs.can-sign == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}-checksums
          path: |
            ${{ matrix.output-path }}.sha256.asc

  build-exe-windows-amd64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5 # Standard stable version
        with:
          python-version: '3.13'

      - name: Install deps
        run: |
          python -m venv venv
          .\venv\Scripts\python -m pip install --upgrade pip
          .\venv\Scripts\pip install -r src/requirements.txt
          .\venv\Scripts\pip install Nuitka

      - name: Download CodeScene CLI zip
        run: |
          Invoke-WebRequest -Uri "https://downloads.codescene.io/enterprise/cli/cs-windows-amd64-latest.zip" -OutFile "codescene-cli-windows.zip"
          Expand-Archive -Path "codescene-cli-windows.zip" -DestinationPath "."

      - name: Build Executable
        run: |
          .\venv\Scripts\python -m nuitka --onefile `
            --assume-yes-for-downloads `
            --include-data-dir=./src/docs=src/docs `
            --include-data-files=./cs.exe=cs.exe `
            --output-filename=cs-mcp.exe `
            src/cs_mcp_server.py

      - name: Upload Executable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cs-mcp-amd64.exe
          path: cs-mcp.exe

  # build-exe-windows-aarch64:
  #   runs-on: windows-11-arm
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
      
  #     - uses: actions/setup-python@v5 # Standard stable version
  #       with:
  #         python-version: '3.13'

  #     - name: Install deps
  #       run: |
  #         python -m venv venv
  #         .\venv\Scripts\python -m pip install --upgrade pip
  #         .\venv\Scripts\pip install -r src/requirements.txt
  #         .\venv\Scripts\pip install Nuitka

  #     - name: Download CodeScene CLI zip
  #       run: |
  #         Invoke-WebRequest -Uri "https://downloads.codescene.io/enterprise/cli/cs-windows-amd64-latest.zip" -OutFile "codescene-cli-windows.zip"
  #         Expand-Archive -Path "codescene-cli-windows.zip" -DestinationPath "."

  #     - name: Build Executable
  #       run: |
  #         .\venv\Scripts\python -m nuitka --onefile `
  #           --assume-yes-for-downloads `
  #           --include-data-dir=./src/docs=src/docs `
  #           --include-data-files=./cs.exe=cs `
  #           --output-filename=cs-mcp.exe `
  #           src/cs_mcp_server.py

  #     - name: Upload Executable Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: cs-mcp-aarch64.exe
        
  publish-to-release:
    permissions:
      contents: write 
    needs: [build-exe-unix, build-exe-windows-amd64]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-binaries
          merge-multiple: true

      - name: Upload to Existing Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ./all-binaries/*
          append_body: true